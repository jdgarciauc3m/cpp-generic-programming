\subsection{Templates and dynamic libraries}

\begin{frame}[t,fragile]{Generic libraries}
\begin{itemize}
  \item A possible optimization idea:
    \begin{itemize}
      \item Generate most common instantiations in a dynamic library.
      \item Aim: Minimize instantiation time and avoid duplications.
    \end{itemize}
\end{itemize}

\begin{columns}[T]

\column{.3\textwidth}
\begin{block}{fixed\_vector.hpp}
\begin{lstlisting}[basicstyle=\tiny]
#ifndef FIXEDVEC_LIBRARY_H
#define FIXEDVEC_LIBRARY_H

template <typename T>
class fixed_vector {
  //...
};

#endif
\end{lstlisting}
\end{block}

\column{.4\textwidth}

\begin{block}{numbers.hpp}
\begin{lstlisting}[basicstyle=\tiny]
#ifndef NUMBERS_LIBRARY_HPP
#define NUMBERS_LIBRARY_HPP

#include "fixed_vector.hpp"

template <typename T>
T compute(fixed_vector<T> const & vec) {
  T res{};
  //...
  return res;
}

#endif //NUMBERS_LIBRARY_HPP

\end{lstlisting}
\end{block}

\column{.35\textwidth}
\begin{block}{main.cpp}
\begin{lstlisting}[basicstyle=\tiny]
#include <iostream>
#include <format>

#include "numbers.hpp"

int main() {
  fixed_vector<int> vec{200};
  vec.push_back(1);
  vec.push_back(2);
  vec.push_back(3);
  vec.print(std::cout);
  auto res = computer(vec);
  //...
};
\end{lstlisting}
\end{block}
\end{columns}
\end{frame}

\begin{frame}[t,fragile]{Libraries}
\mode<presentation>{\vspace{-1em}}
\begin{columns}[T]

\column{.5\textwidth}
\begin{block}{fixed\_vector.cpp}
\begin{lstlisting}[basicstyle=\tiny]
#include "fixed_vector.hpp"
template class fixed_vector<int>;
\end{lstlisting}
\end{block}

\column{.5\textwidth}
\begin{block}{numbers.cpp}
\begin{lstlisting}[basicstyle=\tiny]
#include "numbers.hpp"
template int compute(fixed_vector<int> const &);
\end{lstlisting}
\end{block}
\end{columns}

\begin{itemize}
  \item \textmark{Intention}: 
    \begin{itemize}
      \item Generate a single instance of \cppid{fixed\_vector<int>}
            in \cppkey{libfixed\_vector.so}.
      \item Cross reference from \cppkey{libnumbers.so} and executable \cppkey{main}.
    \end{itemize}
\end{itemize}

\mode<presentation>{\vspace{-1em}}
\begin{columns}[T]

\column{.5\textwidth}
\begin{lstlisting}[style=terminal=escapechar=@,basicstyle=\tiny]
nm -CD --defined-only libfixedvec.so | grep fix
000000000000253c W fixed_vector<int>::push_back(int const&)
00000000000024d6 W fixed_vector<int>::fixed_vector(unsigned long)
00000000000024d6 W fixed_vector<int>::fixed_vector(unsigned long)
00000000000026a4 W fixed_vector<int>::size() const
00000000000025ee W fixed_vector<int>::print(std::ostream&) const
00000000000025a6 W fixed_vector<int>::operator[](unsigned long) const
\end{lstlisting}

\column{.5\textwidth}
\begin{lstlisting}[style=terminal=escapechar=@,basicstyle=\tiny]
nm -CD --defined-only libnumbers.so | grep fix
0000000000001295 W int compute<int>(fixed_vector<int> const&)
00000000000012ee W fixed_vector<int>::size() const
0000000000001304 W fixed_vector<int>::operator[](unsigned long) const
\end{lstlisting}
\end{columns}
\end{frame}

\begin{frame}[t,fragile]{Problems}
\begin{itemize}
  \item \textbad{Multiple instantiations} for \cppid{fixed\_vector<int>}:
    \begin{itemize}
      \item All member functions in \cppkey{libfixed\_vector.so}.
      \item Used member functions in \cppkey{libnumbers.so}.
    \end{itemize}

  \mode<presentation>{\vfill\pause}
  \item \textmark{Impact}:
    \begin{itemize}
      \item \textbad{Code duplication}.
      \item \textbad{Impossible} to specify that the instation generated
            in one library is used from another library.
      \item \textbad{Impossible} to control generation of some artifacts
            generated by the compiler.
      \item \textbad{Higher} compilation and build times.
    \end{itemize}
\end{itemize}
\end{frame}
